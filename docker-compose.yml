
services:
  # MinIO - S3-compatible Object Storage for Iceberg
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /minio_data --console-address ":9001"
    volumes:
      - minio_data:/minio_data
    networks:
      - iceberg-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Trino - Query Engine for Iceberg
  trino:
    image: trinodb/trino:latest
    container_name: trino
    ports:
      - "9090:8080"
    volumes:
      - ./trino/etc:/etc/trino
      - ./trino/catalogs:/etc/trino/catalogs
    environment:
      TRINO_CONFIG: /etc/trino/config.properties
    networks:
      - iceberg-network
    depends_on:
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/info"]
      interval: 30s
      timeout: 20s
      retries: 3

  # One-shot service to fetch recommended Iceberg JARs into ./spark/jars
  fetch-jars:
    image: curlimages/curl:latest
    container_name: fetch-jars
    volumes:
      - ./spark/jars:/opt/spark-apps/jars
      - ./scripts:/scripts:ro
    networks:
      - iceberg-network
    command: ["sh", "-c", "/scripts/download_iceberg_jars.sh"]
    restart: 'no'
    # start early so other services can find jars (depends_on only orders startup)
    depends_on:
      - minio

  # Spark Master
  spark-master:
    image: spark:4.0.1-scala2.13-java21-python3-ubuntu
    container_name: spark-master
    ports:
      - "7077:7077"
      - "8080:8080"
    environment:
      SPARK_MODE: master
      SPARK_RPC_AUTHENTICATION_ENABLED: "no"
      SPARK_RPC_ENCRYPTION_ENABLED: "no"
      SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: "no"
      SPARK_SSL_ENABLED: "no"
    volumes:
      - spark_master_data:/bitnami/spark
      - ./spark/jars:/opt/spark-apps/jars
      - ./spark/conf:/opt/spark-apps/conf
      - ./scripts:/scripts:ro
    networks:
      - iceberg-network
    command: ["sh", "-c", "/scripts/wait-and-start-spark.sh"]

  # Spark Worker 1
  spark-worker-1:
    image: spark:4.0.1-scala2.13-java21-python3-ubuntu
    container_name: spark-worker-1
    ports:
      - "8081:8081"
    environment:
      SPARK_MODE: worker
      SPARK_MASTER_URL: spark://spark-master:7077
      SPARK_WORKER_MEMORY: 1G
      SPARK_WORKER_CORES: 1
      SPARK_RPC_AUTHENTICATION_ENABLED: "no"
      SPARK_RPC_ENCRYPTION_ENABLED: "no"
      SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: "no"
      SPARK_SSL_ENABLED: "no"
    volumes:
      - spark_worker_1_data:/bitnami/spark
      - ./spark/jars:/opt/spark-apps/jars
      - ./spark/conf:/opt/spark-apps/conf
      - ./scripts:/scripts:ro
    networks:
      - iceberg-network
    depends_on:
      - spark-master
    command: ["sh", "-c", "/scripts/wait-and-start-spark.sh"]

  # Spark Worker 2
  spark-worker-2:
    image: spark:4.0.1-scala2.13-java21-python3-ubuntu
    container_name: spark-worker-2
    ports:
      - "8082:8081"
    environment:
      SPARK_MODE: worker
      SPARK_MASTER_URL: spark://spark-master:7077
      SPARK_WORKER_MEMORY: 1G
      SPARK_WORKER_CORES: 1
      SPARK_RPC_AUTHENTICATION_ENABLED: "no"
      SPARK_RPC_ENCRYPTION_ENABLED: "no"
      SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: "no"
      SPARK_SSL_ENABLED: "no"
    volumes:
      - spark_worker_2_data:/bitnami/spark
      - ./spark/jars:/opt/spark-apps/jars
      - ./spark/conf:/opt/spark-apps/conf
      - ./scripts:/scripts:ro
    networks:
      - iceberg-network
    depends_on:
      - spark-master
    command: ["sh", "-c", "/scripts/wait-and-start-spark.sh"]

  # Jupyter Notebook with PySpark and Iceberg
  jupyter:
    image: quay.io/jupyter/pyspark-notebook:spark-4.0.1
    container_name: jupyter
    ports:
      - "8888:8888"
    environment:
      JUPYTER_ENABLE_LAB: "true"
      SPARK_MASTER: spark://spark-master:7077
    volumes:
      - jupyter_data:/home/jovyan/work
      - ./spark/jars:/opt/spark-apps/jars:ro
      - ./notebooks:/home/jovyan/notebooks
    networks:
      - iceberg-network
    depends_on:
      - spark-master
      - spark-worker-1
      - spark-worker-2
      - minio
    command: >
      bash -c "
        # Install Python dependencies
        pip install --quiet pyiceberg[pyarrow] boto3 setuptools wheel &&

        # Start Jupyter normally
        start-notebook.sh --NotebookApp.token='' --NotebookApp.password=''
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  minio_data:
  spark_master_data:
  spark_worker_1_data:
  spark_worker_2_data:
  jupyter_data:

networks:
  iceberg-network:
    driver: bridge
